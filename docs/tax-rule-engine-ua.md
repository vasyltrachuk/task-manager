# Архітектура податкового rule-engine (Україна)

## 1) Ціль
Побудувати систему, яка:
- формує `tax profile` клієнта (ФОП/ТОВ/ГО/інша ЮО);
- автоматично визначає обовʼязкові податкові/звітні дії;
- генерує календар і повторювані задачі для бухгалтерів;
- зберігає юридичну підставу кожного правила (статті законів).

## 2) Що показав ваш Excel (фактичний зріз)
На основі файлу `/Users/admin/Downloads/Завдання для компаній.xlsx`:

- `Аркуш1` (переважно ЮО): 45 клієнтів
  - ПДВ: 33
  - Наймані: 35
  - Акциз: 8
  - Квартальний прибуток/баланс: 8
  - Земля: 3
  - Нерухомість: 2
  - Екоподаток: 1
- `Аркуш2` (переважно ФОП): 76 клієнтів
  - Групи ЄП: 1 група — 6, 2 група — 48, 3 група — 19
  - Наймані: 28
  - Акциз: 2
  - Річна звітність: 54

Висновок: найцінніша модель — **профіль + теги + версійні правила**, а не ручний список задач по кожній компанії.

## 3) Запропонована модель даних

### Tax Profile (вхід для двигуна)
Мінімально потрібні поля:
- `subject`: `fop | llc | ngo | osbb | grant`
- `tax_system`: `single_tax_group1..4 | general_vat | general_no_vat | non_profit`
- `is_vat_payer`
- `employee_count`, `has_employees`
- `tax_tags`: нормалізовані сигнали (`excise`, `land_tax`, `real_estate_tax`, `ecological_tax`, `profit_tax_quarterly`, ...)
- `risk_flags`: відсутні критичні дані (`missing_tax_system`, `missing_tax_id`, `unknown_tax_tags`)

### Rule (каталог правил)
Кожне правило повинно містити:
- `code`
- `title`
- `cadence`: `monthly | quarterly | annual | event`
- `due_rule`: машинозрозуміле правило дедлайну
- `isApplicable(profile)`
- `legal_basis[]`: статті ПКУ/закону

### Task Template (вихід rule-engine)
- шаблон задачі з типом (`tax_report`, `payment`, ...), пріоритетом, assignee-policy;
- параметри дедлайну (`due_rule`);
- юридичні підстави для аудиту.

## 4) Алгоритм генерації задач
1. **Build profile**: клієнт + ліцензії + теги.
2. **Normalize tags**: приводимо `акциз/земля/нерухомість/екологія/квартал` до системних тегів.
3. **Match rules**: фільтр каталогу через `isApplicable`.
4. **Calculate periods**: місяць/квартал/рік.
5. **Resolve due dates** з урахуванням п.49.20 ПКУ (перенесення з вихідного/святкового).
6. **Create tasks**: одна активна задача на правило+період (idempotency key).
7. **Escalation**: прострочення, red-flag, дублікати.

## 5) Базова матриця правил (ядро)

| Сигнал профілю | Дія | Періодичність | Дедлайн-правило | Юр.підстава |
|---|---|---|---|---|
| ФОП 1-2 | Сплата ЄП | Щомісяця | до 20 числа поточного місяця | ПКУ 295.1 |
| ФОП 1-2 | Декларація ЄП | Щороку | 60 днів після кінця року | ПКУ 296.2, 49.18.3 |
| ФОП 3 | Декларація ЄП | Щокварталу | 40 днів після кварталу | ПКУ 296.3, 49.18.2 |
| ФОП | ЄСВ за себе | Щокварталу | до 20 числа місяця після кварталу | Закон 2464-VI, ст.9 ч.8 |
| Платник ПДВ | Декларація ПДВ | Щомісяця | 20 днів після кінця місяця | ПКУ 202.1, 203.1 |
| Платник ПДВ | Сплата ПДВ | Щомісяця | 10 днів після дедлайну декларації | ПКУ 203.2 |
| Наймані (не ФОП-агент) | Податковий розрахунок ПДФО/ВЗ/ЄСВ | Щомісяця | строки місячного періоду | ПКУ 51.1, 176.2 |
| Наймані (ФОП-агент) | Податковий розрахунок ПДФО/ВЗ/ЄСВ | Щокварталу | строки квартального періоду | ПКУ 51.1, 176.2, 49.18.2 |
| Акциз | Декларація + сплата | Щомісяця | до 20 + сплата +10 днів | ПКУ 223.2, 222.3.1 |
| Плата за землю (ЮО) | Декларація | Щороку | до 20 лютого | ПКУ 286.2 |
| Плата за землю (ЮО) | Сплата | Щомісяця | 30 днів після кінця місяця | ПКУ 287.3 |
| Нерухомість (ЮО) | Декларація | Щороку | до 20 лютого | ПКУ 266.7.5 |
| Нерухомість (ЮО) | Авансові внески | Щокварталу | до 30 числа місяця після кварталу | ПКУ 266.10.1 |
| Екоподаток | Декларація + сплата | Щокварталу | 40 днів + сплата 10 днів | ПКУ 250.2 |
| Неприбуткова організація | Річний звіт + фінзвітність | Щороку | 60 днів після року | ПКУ 133.4, 46.2, 49.18.3 |

## 6) Критично важливі нюанси для 2026
- Для більшості податкових агентів розрахунок ПДФО/ВЗ/ЄСВ вже привʼязаний до **місячного** строку, а для ФОП/незалежної профдіяльності — **квартального** (ПКУ 51.1, 176.2 у чинній редакції).
- Перенесення дедлайну з вихідного/святкового дня — п.49.20 ПКУ.
- По ЄСВ за себе є воєнні спеціальні норми, які змінюються по роках; тому rulebook має бути **versioned by year** (Закон 2464-VI, розд. VIII).

## 7) Що вже реалізовано в коді
Оновлено `tax-profile` модуль:
- розширено типи профілю (`tax_tags`, `unknown_tax_tags`, `due_rule`, `legal_basis`);
- додано нормалізацію тегів із `additional_tax_tags`;
- додано ядро правил для ПДВ/ЄП/ЄСВ/Payroll/акцизу/землі/нерухомості/екоподатку/неприбуткових;
- додано тести на rule matching і unknown tags.

Файли:
- `/Users/admin/Develop/task-manager/src/lib/tax-profile/types.ts`
- `/Users/admin/Develop/task-manager/src/lib/tax-profile/catalog.ts`
- `/Users/admin/Develop/task-manager/src/lib/tax-profile/resolver.ts`
- `/Users/admin/Develop/task-manager/src/lib/tax-profile/resolver.test.ts`

## 8) Наступний етап (для повного автокалендаря)
- Додати таблицю `rulebook_versions` і `rulebook_rules` (effective_from/effective_to).
- Додати `deadline_resolver` (обчислення конкретної дати за `due_rule`).
- Додати воркер генерації задач по активних клієнтах (щоденний cron + idempotency).
- Додати журнал `task_generation_log` (audit trail: чому створено задачу).

## Джерела
- Податковий кодекс України: https://zakon.rada.gov.ua/laws/show/2755-17
- Закон України №2464-VI (ЄСВ): https://zakon.rada.gov.ua/laws/show/2464-17
- Закон України №996-XIV (бухоблік): https://zakon.rada.gov.ua/laws/show/996-14
